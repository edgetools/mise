#!/usr/bin/env sh

set -e

MODULE_DIR="$(
  # try to follow symlink
  bin_path="$(
    readlink "$0" || echo "$0"
  )"
  cd "$( dirname "${bin_path}" )" > /dev/null
  cd ..
  pwd
)"

if [ -n "${DEBUG}" ]
then
  echo >&2 "MODULE_DIR: ${MODULE_DIR}"
fi

generate_pwsh_command() {
  cat <<EOL
& {
  # add MODULE_DIR to PSModulePath
  \$env:PSModulePath = "${MODULE_DIR}:\${env:PSModulePath}"
  # import mise
  Import-Module mise -Force -ErrorAction Stop;
  # invoke the cli, passing any args
  Invoke-MiseCli${*+" ${*}"};
}
EOL
}

if [ "${1}" = "shell" ]
then
  exec pwsh-preview -NoExit -Command "$(generate_pwsh_command "$@")"
else
  exec pwsh-preview -Command "$(generate_pwsh_command "$@")"
fi
